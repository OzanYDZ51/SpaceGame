name: Build and Release Imperion Online

on:
  push:
    branches: [main]
    paths-ignore:
      - 'launcher/**'
      - 'backend/**'
      - 'gameserver/**'
      - '*.md'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    # Skip if commit message starts with "ci:" (avoid infinite loop from version bump)
    if: "!startsWith(github.event.head_commit.message, 'ci:')"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Bump version
        id: version
        run: |
          CURRENT=$(cat VERSION | tr -d '[:space:]')
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"
          PATCH=$((PATCH + 1))
          NEW_VERSION="$MAJOR.$MINOR.$PATCH"
          echo "$NEW_VERSION" > VERSION
          # Update constants.gd
          sed -i "s/const GAME_VERSION: String = \".*\"/const GAME_VERSION: String = \"$NEW_VERSION\"/" scripts/core/constants.gd
          echo "version=$NEW_VERSION" >> "$GITHUB_OUTPUT"
          echo "tag=v$NEW_VERSION" >> "$GITHUB_OUTPUT"

      - name: Commit version bump
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add VERSION scripts/core/constants.gd
          git commit -m "ci: bump version to ${{ steps.version.outputs.version }}"
          git pull --rebase
          git push

      - name: Download Godot
        run: |
          GODOT_VERSION="4.6-stable"
          wget -q "https://github.com/godotengine/godot/releases/download/${GODOT_VERSION}/Godot_v${GODOT_VERSION}_linux.x86_64.zip" -O godot.zip
          unzip -q godot.zip
          mv Godot_v${GODOT_VERSION}_linux.x86_64 /usr/local/bin/godot
          chmod +x /usr/local/bin/godot

      - name: Download export templates
        run: |
          GODOT_VERSION="4.6-stable"
          wget -q "https://github.com/godotengine/godot/releases/download/${GODOT_VERSION}/Godot_v${GODOT_VERSION}_export_templates.tpz" -O templates.tpz
          mkdir -p ~/.local/share/godot/export_templates/4.6.stable
          unzip -q templates.tpz
          mv templates/* ~/.local/share/godot/export_templates/4.6.stable/

      - name: Import project
        run: |
          cd ${{ github.workspace }}
          godot --headless --import 2>&1 || true
          # Run twice to ensure all imports are processed
          godot --headless --import 2>&1 || true

      - name: Export game
        run: |
          mkdir -p build
          cd ${{ github.workspace }}
          godot --headless --export-release "Windows Desktop" build/ImperionOnline.exe

      - name: Package release
        run: |
          cd build
          zip -r ../ImperionOnline.zip ImperionOnline.exe ImperionOnline.pck

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: Imperion Online ${{ steps.version.outputs.tag }}
          body: "Automated build from commit ${{ github.sha }}"
          files: ImperionOnline.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Post devlog to Discord
        if: success()
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          # Collect raw commit message (strip CI trailers)
          RAW_MSG=$(git log -1 --pretty=%B --skip=1 | grep -v 'Co-Authored-By:' | sed '/^[[:space:]]*$/d' | head -20)
          if [ -z "$RAW_MSG" ]; then
            RAW_MSG="Misc changes"
          fi

          # Collect diff stat for context (what files/systems changed)
          DIFF_STAT=$(git diff --stat HEAD~1 HEAD 2>/dev/null | tail -30)

          # === Gemini AI: rewrite commit into player-friendly devlog ===
          AI_MSG=""
          if [ -n "$GEMINI_API_KEY" ]; then
            SYSTEM_PROMPT=$(cat <<'PROMPT_EOF'
          Tu rediges les notes de patch d'Imperion Online, un MMO spatial.
          Tu recois un commit technique et tu le transformes en devlog lisible par des joueurs.

          FORMAT OBLIGATOIRE (toujours cette structure):
          - Chaque changement = une ligne
          - Chaque ligne commence par UN emoji puis un tiret puis la description
          - Separe en categories si 3+ changements: NOUVEAU, AMELIORATION, CORRECTION (en gras **)
          - Si 1-2 changements, pas besoin de categories, juste les lignes

          TON ET STYLE:
          - Francais naturel, comme un vrai dev qui parle a sa communaute
          - Factuel et concret: dis ce qui a change, pas pourquoi c est genial
          - Court. Une ligne = une info. Pas de bla-bla.
          - Vocabulaire in-game: vaisseaux, systemes, stations spatiales, carte stellaire, escadron, armement, boucliers...

          INTERDIT (ca fait IA tout de suite):
          - "Pilotes !", "Commandants !", "Bon vol !", "N hesitez pas", "Restez connectes"
          - Hashtags, questions rhetoriques, points de suspension...
          - Superlatifs vides: "incroyable", "revolutionnaire", "tant attendu"
          - Commencer par "Mise a jour" (c est deja dans le titre Discord)
          - Expliquer des details techniques (fichiers, code, refactoring, optimisation interne)
          - Plus de 5 lignes

          EXEMPLES DE BON DEVLOG:

          Exemple 1 (gros patch):
          **NOUVEAU**
          Systeme d ordres de flotte â€” assignez des missions a vos vaisseaux depuis la carte stellaire
          Menu contextuel sur la carte pour interagir avec vos escadrons deployes

          **AMELIORATION**
          Carte stellaire plus lisible avec un nouveau layout

          **CORRECTION**
          Le chat ne se fermait plus apres envoi d un message

          Exemple 2 (petit patch):
          Correction d un probleme d affichage sur la carte galactique
          Les tourelles de station repondent maintenant correctement aux agressions

          Exemple 3 (une seule correction):
          Les boucliers directionnels se rechargent maintenant au bon rythme
          PROMPT_EOF
          )

            GEMINI_BODY=$(jq -n \
              --arg prompt "$SYSTEM_PROMPT" \
              --arg msg "$RAW_MSG" \
              --arg diff "$DIFF_STAT" \
              '{
                "contents": [{
                  "parts": [{"text": ($prompt + "\n\n--- COMMIT ---\n" + $msg + "\n\n--- FICHIERS MODIFIES ---\n" + $diff)}]
                }],
                "generationConfig": {
                  "temperature": 0.5,
                  "maxOutputTokens": 400
                }
              }')

            GEMINI_RESPONSE=$(curl -s --max-time 15 -X POST \
              "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=$GEMINI_API_KEY" \
              -H "Content-Type: application/json" \
              -d "$GEMINI_BODY" 2>/dev/null)

            AI_MSG=$(echo "$GEMINI_RESPONSE" | jq -r '.candidates[0].content.parts[0].text // empty' 2>/dev/null)
          fi

          # === Fallback if Gemini unavailable or failed ===
          if [ -z "$AI_MSG" ]; then
            if echo "$RAW_MSG" | head -1 | grep -qiE '(^Merge|^Fix build|^Fix CI|^Revert|_[a-z]|[a-z]_[a-z]|\.(gd|go|json|yml|md|toml|tres|tscn)\b)'; then
              AI_MSG="ðŸ”§ Corrections et ameliorations diverses"
            else
              AI_MSG="$RAW_MSG"
            fi
          fi

          # Post to backend changelog API (stores in DB + sends Discord webhook)
          curl -s -X POST "$BACKEND_URL/api/v1/admin/changelog" \
            -H "X-Admin-Key: $ADMIN_KEY" \
            -H "Content-Type: application/json" \
            -d "{\"version\": \"$VERSION\", \"summary\": $(echo "$AI_MSG" | jq -Rs .)}" || true
        env:
          BACKEND_URL: https://backend-production-05a9.up.railway.app
          ADMIN_KEY: 2f0aa1697a095884517c4eb4b3777b65
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
