name: Build and Release Imperion Online

on:
  push:
    branches: [main]
    paths-ignore:
      - 'launcher/**'
      - 'backend/**'
      - 'gameserver/**'
      - '*.md'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    # Skip if commit message starts with "ci:" (avoid infinite loop from version bump)
    if: "!startsWith(github.event.head_commit.message, 'ci:')"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Bump version
        id: version
        run: |
          CURRENT=$(cat VERSION | tr -d '[:space:]')
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"
          PATCH=$((PATCH + 1))
          NEW_VERSION="$MAJOR.$MINOR.$PATCH"
          echo "$NEW_VERSION" > VERSION
          # Update constants.gd
          sed -i "s/const GAME_VERSION: String = \".*\"/const GAME_VERSION: String = \"$NEW_VERSION\"/" scripts/core/constants.gd
          echo "version=$NEW_VERSION" >> "$GITHUB_OUTPUT"
          echo "tag=v$NEW_VERSION" >> "$GITHUB_OUTPUT"

      - name: Commit version bump
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          git add VERSION scripts/core/constants.gd
          git commit -m "ci: bump version to ${{ steps.version.outputs.version }}"
          git pull --rebase
          git push

      - name: Download Godot
        run: |
          GODOT_VERSION="4.6-stable"
          wget -q "https://github.com/godotengine/godot/releases/download/${GODOT_VERSION}/Godot_v${GODOT_VERSION}_linux.x86_64.zip" -O godot.zip
          unzip -q godot.zip
          mv Godot_v${GODOT_VERSION}_linux.x86_64 /usr/local/bin/godot
          chmod +x /usr/local/bin/godot

      - name: Download export templates
        run: |
          GODOT_VERSION="4.6-stable"
          wget -q "https://github.com/godotengine/godot/releases/download/${GODOT_VERSION}/Godot_v${GODOT_VERSION}_export_templates.tpz" -O templates.tpz
          mkdir -p ~/.local/share/godot/export_templates/4.6.stable
          unzip -q templates.tpz
          mv templates/* ~/.local/share/godot/export_templates/4.6.stable/

      - name: Import project
        run: |
          cd ${{ github.workspace }}
          godot --headless --import 2>&1 || true
          # Run twice to ensure all imports are processed
          godot --headless --import 2>&1 || true

      - name: Export game
        run: |
          mkdir -p build
          cd ${{ github.workspace }}
          godot --headless --export-release "Windows Desktop" build/ImperionOnline.exe

      - name: Package release
        run: |
          cd build
          zip -r ../ImperionOnline.zip ImperionOnline.exe ImperionOnline.pck

      - name: Generate manifest
        run: |
          cd build
          EXE_HASH=$(sha256sum ImperionOnline.exe | cut -d' ' -f1)
          PCK_HASH=$(sha256sum ImperionOnline.pck | cut -d' ' -f1)
          cat > manifest.json <<EOF
          {
            "version": "${{ steps.version.outputs.version }}",
            "files": {
              "ImperionOnline.exe": "$EXE_HASH",
              "ImperionOnline.pck": "$PCK_HASH"
            }
          }
          EOF
          cat manifest.json

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: Imperion Online ${{ steps.version.outputs.tag }}
          body: "Automated build from commit ${{ github.sha }}"
          files: |
            ImperionOnline.zip
            build/manifest.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Post devlog to Discord
        if: success()
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          # Collect raw commit message (strip CI trailers)
          RAW_MSG=$(git log -1 --pretty=%B --skip=1 | grep -v 'Co-Authored-By:' | sed '/^[[:space:]]*$/d' | head -20)
          if [ -z "$RAW_MSG" ]; then
            RAW_MSG="Misc changes"
          fi

          # Collect diff stat for context (what files/systems changed)
          DIFF_STAT=$(git diff --stat HEAD~1 HEAD 2>/dev/null | tail -30)

          # === Gemini AI: rewrite commit into player-friendly devlog ===
          AI_MSG=""
          if [ -n "$GEMINI_API_KEY" ]; then
            SYSTEM_PROMPT=$(cat <<'PROMPT_EOF'
          Tu rediges les notes de patch d'Imperion Online, un MMO spatial (Star Citizen / X4 / Elite Dangerous).
          Tu recois un commit technique et tu le transformes en VRAI devlog complet, detaille et structure.

          FORMAT OBLIGATOIRE:
          - Organise par categories en gras (**NOUVEAU**, **AMELIORATION**, **CORRECTION**)
          - N inclus QUE les categories qui ont du contenu
          - Sous chaque categorie, liste a puces avec emoji par ligne
          - Chaque puce = emoji + titre court en gras + tiret + description detaillee sur la meme ligne
          - Si le patch touche un systeme de jeu (combat, flotte, minage, commerce...), nomme-le
          - Si un seul petit changement, pas besoin de categorie

          NIVEAU DE DETAIL:
          - Chaque changement merite 1-2 phrases de description, pas juste un titre
          - Explique CONCRETEMENT ce que le joueur peut faire de nouveau ou ce qui a change pour lui
          - Mentionne ou ca se passe dans le jeu (en vol, en station, sur la carte, au combat...)
          - Si c est une correction, dis ce qui n allait pas AVANT et comment ca marche MAINTENANT

          TON ET STYLE:
          - Francais naturel, ton de dev qui parle a sa communaute gaming
          - Factuel et immersif: mets le joueur dans le contexte du jeu
          - Vocabulaire in-game: vaisseaux, systemes stellaires, stations, escadrons, armement, boucliers, carte galactique, cockpit, tourelles, cargaison...
          - Sois exhaustif: couvre TOUS les changements visibles, ne resume pas a la va-vite

          INTERDIT (ca fait IA):
          - "Pilotes !", "Commandants !", "Bon vol !", "N hesitez pas", "Restez connectes"
          - Hashtags, questions rhetoriques, points de suspension a repetition
          - Superlatifs vides: "incroyable", "revolutionnaire", "tant attendu"
          - Commencer par "Mise a jour" (c est deja dans le titre Discord)
          - Details techniques: noms de fichiers, fonctions, classes, frameworks, "refactoring", "optimisation du code"
          - Phrases d intro ou de conclusion generiques

          EXEMPLE COMPLET:

          **NOUVEAU**
          ðŸŽ¯ **Ordres de flotte** â€” vous pouvez maintenant donner des ordres a vos vaisseaux deployes directement depuis la carte stellaire. Clic droit sur un systeme pour envoyer un escadron en patrouille, en escorte ou en mission de minage.
          ðŸ“¡ **Menu contextuel** â€” un clic droit sur la carte fait apparaitre un menu pour interagir avec vos escadrons, les rappeler ou changer leur mission en temps reel.

          **AMELIORATION**
          ðŸ—ºï¸ **Carte stellaire** â€” le layout a ete entierement retravaille. Les systemes sont mieux espaces, les lignes de saut plus lisibles et les icones de stations plus visibles en zoom arriere.
          âš”ï¸ **Ciblage** â€” le marqueur de cible et le reticule de visee sont maintenant centres sur le coeur du vaisseau ennemi au lieu de son point d ancrage. Plus besoin de deviner ou viser.
          ðŸŽ¨ **Interface** â€” les menus adoptent une nouvelle identite visuelle orange et ambre inspiree d Elite Dangerous, avec des effets holographiques et des transitions fluides.

          **CORRECTION**
          ðŸ”§ **Chat en vol** â€” le chat se fermait automatiquement juste apres avoir envoye un message, obligeant a rappuyer sur Entree. C est corrige, vous pouvez enchainer les messages.
          ðŸ”§ **Camera** â€” dans certaines orientations extremes du vaisseau (pique ou chandelle), la camera pouvait trembler ou tourner sur elle-meme. Stabilite retrouvee.
          PROMPT_EOF
          )

            GEMINI_BODY=$(jq -n \
              --arg prompt "$SYSTEM_PROMPT" \
              --arg msg "$RAW_MSG" \
              --arg diff "$DIFF_STAT" \
              '{
                "contents": [{
                  "parts": [{"text": ($prompt + "\n\n--- COMMIT ---\n" + $msg + "\n\n--- FICHIERS MODIFIES ---\n" + $diff)}]
                }],
                "generationConfig": {
                  "temperature": 0.5,
                  "maxOutputTokens": 1500
                }
              }')

            GEMINI_RESPONSE=$(curl -s --max-time 15 -X POST \
              "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=$GEMINI_API_KEY" \
              -H "Content-Type: application/json" \
              -d "$GEMINI_BODY" 2>/dev/null)

            AI_MSG=$(echo "$GEMINI_RESPONSE" | jq -r '.candidates[0].content.parts[0].text // empty' 2>/dev/null)
          fi

          # === Fallback if Gemini unavailable or failed ===
          if [ -z "$AI_MSG" ]; then
            if echo "$RAW_MSG" | head -1 | grep -qiE '(^Merge|^Fix build|^Fix CI|^Revert|_[a-z]|[a-z]_[a-z]|\.(gd|go|json|yml|md|toml|tres|tscn)\b)'; then
              AI_MSG="ðŸ”§ Corrections et ameliorations diverses"
            else
              AI_MSG="$RAW_MSG"
            fi
          fi

          # Post to backend changelog API (stores in DB + sends Discord webhook)
          curl -s -X POST "$BACKEND_URL/api/v1/admin/changelog" \
            -H "X-Admin-Key: $ADMIN_KEY" \
            -H "Content-Type: application/json" \
            -d "{\"version\": \"$VERSION\", \"summary\": $(echo "$AI_MSG" | jq -Rs .)}" || true
        env:
          BACKEND_URL: https://backend-production-05a9.up.railway.app
          ADMIN_KEY: 2f0aa1697a095884517c4eb4b3777b65
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
